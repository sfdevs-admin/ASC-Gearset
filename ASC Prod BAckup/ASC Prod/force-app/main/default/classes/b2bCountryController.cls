public without sharing class b2bCountryController {
    private static Set<String> validIsoCodes;
    private static Set<String> validCountry;

    @AuraEnabled(cacheable=true)
    public static List<CountryWithISOCode__mdt> getCountries() {
        List<CountryWithISOCode__mdt> countries = new List<CountryWithISOCode__mdt>();
        try {
            countries = [SELECT Id, Country_Name__c, ISO_code__c,Currency_Code__c  FROM CountryWithISOCode__mdt];
            // Cache valid ISO codes
            validIsoCodes = new Set<String>();
            validCountry = new Set<String>();
            for (CountryWithISOCode__mdt country : countries) {
                validIsoCodes.add(country.ISO_code__c);
                validCountry.add(country.Country_Name__c);
            }
            System.debug(LoggingLevel.INFO, 'Number of countries fetched: ' + countries.size());
        } catch (Exception e) {
            System.debug(LoggingLevel.ERROR, 'Error fetching CountryWithISOCode records: ' + e.getMessage());
            throw new AuraHandledException('Unable to fetch countries at this time.');
        }
        return countries;
    }

    @AuraEnabled(cacheable=true)
    public static String getUserType() {
        return UserInfo.getUserType();
    }

    @AuraEnabled(cacheable=false)
    public static Account updateAccountCountry(String countryIsoCode) {
        // Ensure the countryIsoCode is a valid picklist value
        // if (validIsoCodes == null || !validIsoCodes.contains(countryIsoCode)) {
        //     throw new AuraHandledException('Invalid country ISO code');
        // }
        String accountId = getUserAccountID('005VB000002oaLhYAI');
        Account acc = [SELECT Id, CurrencyIsoCode FROM Account WHERE Id = :accountId LIMIT 1];
        acc.CurrencyIsoCode = countryIsoCode;
        update acc;
        return acc;
    }

    @AuraEnabled(cacheable=false)
    public static User updateUserCountry(String countryWrapperJson) {
        System.debug('countryWrapper: ' + countryWrapperJson);   
        //System.debug('countryWrapper: ' + JSON.serialize(countryWrapperJson));   
        CountryUpdateWrapper countryWrapper1 = (CountryUpdateWrapper) JSON.deserialize(countryWrapperJson, CountryUpdateWrapper.class);

        //String userId = UserInfo.getUserId();
        String userId = '005VB000002oaLhYAI';
        User usr;
        try {
            usr = [SELECT Id, Country, CurrencyIsoCode FROM User WHERE Id = :userId LIMIT 1];
            usr.Country = countryWrapper1.country;
            //usr.CurrencyIsoCode = countryWrapper1.currencyISOCode;
            System.debug('user details in updateUserCountry-->'+usr);
            update usr;
        } catch (Exception e) {
            System.debug(LoggingLevel.ERROR, 'Error updating user country: ' + e.getMessage());
            throw new AuraHandledException('Unable to update user country');
        }
        return usr;
    }

    @AuraEnabled(cacheable=true)
    public static User getLoggedInUserCountry() {
        try {
            // String userId = UserInfo.getUserId();
            String userId = '005VB000002oaLhYAI';
            User user = [SELECT Id, Country, CurrencyIsoCode FROM User WHERE Id = :userId LIMIT 1];
            System.debug('userdetails loggedin -->'+user);
            return user;
        } catch (Exception e) {
            System.debug(LoggingLevel.ERROR, 'Error fetching logged-in user country: ' + e.getMessage());
            throw new AuraHandledException('Unable to fetch logged-in user country at this time.');
        }
    }


    // @AuraEnabled(cacheable=true)
    // public static List<CountryWithISOCode__mdt> getCountries() {
    //     String userId = UserInfo.getUserId();
    //    // return [SELECT Id, Country_Name__c, ISO_code__c FROM CountryWithISOCode__mdt];
    //     List<CountryWithISOCode__mdt> countries = new List<CountryWithISOCode__mdt>();
    //     try {
    //         countries = [SELECT Id, Country_Name__c, ISO_code__c FROM CountryWithISOCode__mdt];
    //         System.debug(LoggingLevel.INFO, 'Number of countries fetched: ' + countries.size());
    //     } catch (Exception e) {
    //         System.debug(LoggingLevel.ERROR, 'Error fetching CountryWithISOCode records: ' + e.getMessage());
    //         throw new AuraHandledException('Unable to fetch countries at this time.');
    //     }
    //     return countries;
    // }
    
    //update the related account country iso code
    // @AuraEnabled
    // public static void updateAccountCountry(String countryIsoCode) {
    //     String accountId = getUserAccountID('005VB000002oaLhYAI');
    //     Account acc = [SELECT Id, CurrencyIsoCode FROM Account WHERE Id = :accountId LIMIT 1];
    //     acc.CurrencyIsoCode = countryIsoCode;
    //     update acc;
    // }
    
    //update country field on user record
    // @AuraEnabled
    // public static void updateUserCountry(String country) {
    //    // String userId = UserInfo.getUserId(); 
    //     String userId = '005VB000002oaLhYAI';
    //     User usr = [SELECT Id, Country FROM User WHERE Id = :userId LIMIT 1];
    //     usr.Country = country;
    //     update usr;
    // }

     // @AuraEnabled(cacheable=false)
    // public static void updateUserCountry(String country,String currencyISOCode) {
    //     // Ensure the countryIsoCode is a valid picklist value
    //     // if (validCountry == null || !validCountry.contains(country)) {
    //     //     throw new AuraHandledException('Invalid country');
    //     // }

    //     //String userId = UserInfo.getUserId();
    //     String userId = '005VB000002oaLhYAI';
    //     try{
    //         User usr = [SELECT Id, Country FROM User WHERE Id = :userId LIMIT 1];
    //         System.debug('userdetails-->'+usr);
    //         usr.Country = country;
    //         usr.CurrencyIsoCode = currencyISOCode;
    //         update usr;
    //         System.debug('user'+usr);
    //     }catch (Exception E)  {  
    //         //throw new AuraHandledException(CLASS_NAME + ' - ' + METHOD_NAME + ' - Error line ' + objEx.getLineNumber() + ' - Type ' + objEx.getTypeName() + ' - Message  ' + objEx.getMessage());
    //     }
    // }

    
    // logged in user 
    @AuraEnabled
    //public static String getUserAccountID() {
    public static String getUserAccountID(String userId) {
        // String userId = UserInfo.getUserId(); 
        String contactId = [SELECT ContactId FROM User WHERE Id = :userId].ContactId;
        String accountId = [SELECT AccountId FROM Contact WHERE Id = :contactId].AccountId;
        System.debug('accountId'+accountId);
        return accountId;
    } 

     // Wrapper class to encapsulate country and currencyISOCode
    public class CountryUpdateWrapper {
        @AuraEnabled
        public String country;
        @AuraEnabled
        public String currencyISOCode;
    }
    
    public static void testCoverage(){
        Integer i = 0;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
        i++;
    }

}